var doc=document,win=window,cd,SZ,nums,temp,clr,ctr;
var rnd=Math.random,round=Math.round,max=Math.max,min=Math.min,PI=Math.PI;
var CVS=doc.querySelector("#comp1"),CVS2=doc.querySelector("#comp2");
var C=CVS.getContext("2d"),C2=CVS2.getContext("2d");
var bgs=[ [ "#eee", "#ddd" ] ];
var chars=[
	{
		head:{"fillStyle":"#31CF23","verts":[[0.48922729492188,-168.296859741211],[-157.870941162109,-146.577819824219],[-339,-3.00015258789062],[-127.911544799805,104.365585327148],[2,97.9999847412109],[191.477905273438,96.8430023193359],[338,-2],[191.835815429688,-135.583877563477]],"ins":[[61.0107727050781,0],[64.3709259033203,-17.4221801757812],[0,-67.6872711181641],[-96.1539001464844,-5.20269775390625],[0,0],[-90.5111999511719,15.21875],[0,48.9290466308594],[77.0521240234375,28.3908233642578]],"outs":[[-63.9945678710938,0],[-89.9761352539062,24.352294921875],[0,75.1440124511719],[70.1935882568359,3.798095703125],[0,0],[76.262451171875,-12.8229064941406],[0,-49.2546997070312],[-70.3358154296875,-25.9161224365234]]},
		eye1:{"fillStyle":"#000","verts":[[-239,-42],[-211.5,-14],[-248.5,14],[-273.5,-11.5]],"ins":[[-16.0162658691406,0],[0,-16.0162658691406],[16.0162658691406,0],[0,16.0162658691406]],"outs":[[16.0162658691406,0],[0,16.0162658691406],[-16.0162658691406,0],[0,-16.0162658691406]]},
		eye2:{"fillStyle":"#000","verts":[[239.306457519531,-42],[212.25,-14],[248.653228759766,14],[273.25,-11.5]],"ins":[[15.7579498291016,0],[0,-16.0162658691406],[-15.7579345703125,0],[0,16.0162506103516]],"outs":[[-15.7579498291016,0],[0,16.0162658691406],[15.7579345703125,0],[0,-16.0162658691406]]},
		mouth:{"fillStyle":"#fff","verts":[[-159.375,19.125],[-164.25,35.25],[-137,36.5],[-128,52],[-114.625,40.625],[-102,40.5],[-98,58.5],[-84.875,41.75],[-74.6249847412109,41.875],[-64.8749694824219,58.25],[-51.8749542236328,42.125],[-40.7500305175781,41.75],[-28.7500152587891,55.375],[-15.2499694824219,43.5],[14.7499084472656,43.5],[28.2500610351562,55.375],[40.25,42.125],[51.3750305175781,42.25],[64.6250762939453,57.5],[72.8749542236328,45.375],[74.2499694824219,41.5],[83.9999542236328,41.75],[98,57.75],[102.625,40.375],[115.625,40.875],[126.75,51.375],[131,48],[138,36.5],[160.375,36],[165.25,32.625],[161.5,19.75],[156.375,19],[61.8749389648438,20.625],[0.50004577636719,18],[-84.0000305175781,21]],"ins":[[5.25,0],[-2.907470703125,-0.24920654296875],[0,0],[-4,-3.5],[-4.5,1],[0,0],[-3.5,-7],[0,0],[-1.87501525878906,-2.375],[-4.00003051757812,-2.375],[-1.25003051757812,0.25],[-0.625,-0.125],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[-0.37496948242188,1.125],[-0.99998474121094,0.5],[0,0],[0,0],[1.375,9.375],[0,0],[-1.375,-4.25],[-0.625,0.75],[0,0],[-2.625,0.375],[0,1.625],[1.125,0.875],[1.375,0],[17.7500457763672,0],[0,0],[35.0000152587891,0]],"outs":[[-2.82014465332031,0],[4.375,0.375],[0,0],[7,-8],[4.5,-1],[0,0],[5.99995422363281,-8.625],[0,0],[1.87495422363281,2.375],[6.74995422363281,-8.375],[1.24992370605469,-0.25],[0.625,0.125],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0.37503051757812,-1.125],[1.0001220703125,-0.5],[0,0],[0,0],[5.75,-1.25],[0,0],[3.25,-0.375],[0.625,-0.75],[0,0],[2.625,-0.375],[0,-1.625],[-1.125,-0.875],[-1.375,0],[-17.7499084472656,0],[0,0],[-34.9999694824219,0]]} 
	},
	{
		head:{"fillStyle":"#E0C7A3","verts":[[31.7460632324219,-75.154541015625],[22.2460632324219,-62.154541015625],[21.7460632324219,-52.904541015625],[-3.00393676757812,-55.904541015625],[-26.2539367675781,-53.154541015625],[-27.0039367675781,-67.904541015625],[-36.0039367675781,-75.154541015625],[-43.2539367675781,-68.154541015625],[-50.2728576660156,-8.33175659179688],[-52.5039367675781,56.595458984375],[-22.7539367675781,71.345458984375],[-2.25772094726562,70.9066467285156],[16.4960632324219,72.345458984375],[49.9960632324219,51.095458984375],[45.2251586914062,-13.8565063476562],[39.7460632324219,-59.904541015625]],"ins":[[8.25,0],[0,0],[0,0],[12.25,0],[0,0],[0,0],[5.5,0],[0,0],[1.48464965820312,-20.0227355957031],[-1,-5.5],[-21.25,0],[-8.82138061523438,-0.26864624023438],[-3.78768920898438,0],[0.5,4.5],[1.99615478515625,21.6170043945312],[0,0]],"outs":[[-8.25,0],[0,0],[0,0],[-12.25,0],[0,0],[0,0],[-5.5,0],[0,0],[-1.60130310058594,21.5958862304688],[1,5.5],[2.83964538574219,0],[7.48776245117188,0.22802734375],[28.75,0],[-0.5,-4.5],[-1.42134094238281,-15.3921203613281],[0,0]]},
		body:{"fillStyle":"#EFE6DA","verts":[[-3.00393676757812,25.845458984375],[-52.5039367675781,56.595458984375],[-22.7539367675781,71.345458984375],[-2.25772094726562,70.9066467285156],[16.4960632324219,72.345458984375],[47.88330078125,58.6732788085938]],"ins":[[28.25,0],[-1,-5.5],[-21.25,0],[-8.82138061523438,-0.26863098144531],[-3.78768920898438,0],[-3.56175231933594,6.28166198730469]],"outs":[[-24.25,0],[1,5.5],[2.83964538574219,0],[7.48776245117188,0.22802734375],[19.0971374511719,0],[1.80032348632812,-3.17512512207031]]},
		eye1:{"fillStyle":"#000","verts":[[-21.8512725830078,-32.904541015625],[-16.2494812011719,-27.592041015625],[-23.7864227294922,-22.279541015625],[-28.8789367675781,-27.1177368164062]],"ins":[[-3.26255798339844,0],[0,-3.03878784179688],[3.26251220703125,0],[0,3.03875732421875]],"outs":[[3.26255798339844,0],[0,3.03878784179688],[-3.26251220703125,0],[0,-3.03875732421875]]},
		eye2:{"fillStyle":"#000","verts":[[16.9869689941406,-32.904541015625],[11.4960632324219,-27.592041015625],[18.8838043212891,-22.279541015625],[23.8755187988281,-27.1177368164062]],"ins":[[3.19798278808594,0],[0,-3.03878784179688],[-3.19793701171875,0],[0,3.03875732421875]],"outs":[[-3.19798278808594,0],[0,3.03878784179688],[3.19793701171875,0],[0,-3.03875732421875]]},
		nose:{"fillStyle":"#E090B9","verts":[[-2.25393676757812,-22.029541015625],[-10.2539367675781,-21.154541015625],[-2.62893676757812,-11.904541015625],[4.49606323242188,-21.404541015625]],"ins":[[4.25,0],[0,0],[0,-1.625],[0,0]],"outs":[[-4.25,0],[0,0],[0,-2],[0,0]]} 
	}
];
function normInt(s){ return parseInt(s,32)-SZ }
function d2r(n){ return n*PI/180 }
function to1(n){ return n/255 };
function to1N(n){ return n/128-1 };
function getNums(){
	var hashPairs=[],seed,rvs,j=0;
	seed = parseInt( tokenData.hash.slice(0,16), 16 );
	for(j=0;j<32;j++){
		hashPairs.push(
			tokenData.hash.slice( 2+(j*2),4+(j*2) )
		);
	}
	rvs = hashPairs.map(n=>parseInt(n,16));
	return rvs;
}
function clear( C ){ C.clearRect(0,0,SZ,SZ) }
function renderShape( shape, s, o ){
	addShape( shape, s, o, C );
	setStdStyle();
	C.fill();
	addShad(()=>{
		addShape( shape, s, o, C2 );
		C2.fillStyle = clr.char[0];
		C2.lineJoin = "round";
	});
	C.stroke();
}
function canvasAction( callback ){
	C.save();
	C2.save();
	C.beginPath();
	callback( [].slice.call(arguments,1) );
	C.restore();
	C2.restore();
}
function transWithAnchor( x, y, C, callback ){
	C.translate( x, y );
	callback( [].slice.call(arguments,3) );
	C.translate( x*-1, y*-1 );
}
function addShape(shape,s,o,C){
	var vs=shape.verts, is=shape.ins||null, os=shape.outs||null;
	var x=(o?o[0]:SZ/2), y=(o?o[1]:SZ/2), l=vs.length,ax,ay,bx,by,cx,cy,i,j,k;
	C.beginPath();
	C.moveTo( x+vs[l-1][0]*s[0], y+vs[l-1][1]*s[1] );
	for( i=l; i<=l*2+(temp||0); i++ ){
		j=(i-1)%l, k=i%l;
		os ? ax = x+(vs[j][0]+os[j][0])*s[0]:null;
		os ? ay = y+(vs[j][1]+os[j][1])*s[1]:null;
		is ? bx = x+(vs[k][0]+is[k][0])*s[0]:null;
		is ? by = y+(vs[k][1]+is[k][1])*s[1]:null;
		cx = x+vs[k][0]*s[0];
		cy = y+vs[k][1]*s[1];
		if ( is && os ){
			C.bezierCurveTo( ax,ay,bx,by,cx,cy );
		} else {
			C.lineTo( cx,cy );
		}
	}
}
function strokeFill( C ){
	C.stroke();
	C.fill();
}
function setStdStyle( shape ){
	C = arguments[1] || C;
	var stylelist = ["fillStyle","strokeStyle","lineWidth","lineJoin"],style,i;
	var paramlist = ["#aaf","#000",cd.lwidth,"round"];
	for(i=0;i<stylelist.length;i++){
		style = stylelist[i];
		C[style] = (shape&&shape[style]) || paramlist[i];
	}
}
function drawStdStyle( shape ){
	C = arguments[1] || C;
	setStdStyle( shape, C );
	strokeFill( C );
}
function addBG(){
	var grad = C.createRadialGradient( SZ/2, SZ/2, 1, SZ/2, SZ/2, SZ/2 ),i;
	for(i=0;i<2;i++) grad.addColorStop( i, clr.bg[i] );
	C.fillStyle = grad;
	C.fillRect( 0, 0, SZ, SZ );
}
function setRare(){
	for (var p in rares) rares[p] = true;
	main();
}
function handleKeyPress(){
	switch (event.charCode){
	case 32: // spacebar
		setRare();
		break;
	default:
		break;
	}
}
function drawBG(){
	clear( C );
	C.fillStyle = "#eee";
	C.fillRect(0,0,SZ,SZ);
}
function drawChar( args ){
	var parts=["head","body","eye1","eye2","nose","mouth"];
	var n=args[0], sz=args[1]||0.5, idx=args[2]%(nums.length-1);
	var p,i;
	var x1 = ctr[0] + to1N(nums[idx])*SZ/4;
	var x2 = ctr[0] + to1N(nums[idx])*-1*SZ/4;
	var y = ctr[1] + to1N(nums[idx+1])*SZ/4;
	for( i=0;i<parts.length;i++){
		p = parts[i];
		if ( chars[n][p] ){
			addShape( chars[n][p], [sz,sz], [x1,y], C );
			drawStdStyle( chars[n][p] );
		}
	}
}
function render(){
	clear( C );
	canvasAction( drawBG, 0 );
	canvasAction( drawChar, 0, 0.5, 0 );
	canvasAction( drawChar, 1, 1.5, 1 );
}
function init(){
	nums = getNums();
	SZ = 800;
	ctr = [SZ/2,SZ/2];
	CVS.setAttribute( "width", SZ );
	CVS.setAttribute( "height", SZ );
	CVS2.setAttribute( "width", SZ );
	CVS2.setAttribute( "height", SZ );
	clr = {
		bg: [ "#acf", "#05a" ],
		char: [ "#dfd319", "#20e272" ]
	}
	cd = { lwidth:SZ/128, soff:0.1, poff:0.03 }
}
function main(){
	init();
	render();
}
main();
